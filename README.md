# Сервис для хранения ссылок пользователей.

---
[TODO лист](./description/TODO.md)

[Инструкция пользователя](./description/MANUAL.md)

## Запуск с локальной машины.

Предполагается, что проект УЖЕ развёрнут в файловой системе, УЖЕ настроено виртуальное окружение,
создано хранилище данных.

### Подготовка базы данных.

Создайте (или попросите администратора создать) хранилище данных в PostgreSQL, роль для доступа к базе данных.

### Подготовка проекта.

 - установка зависимостей

 ```shell
pip insall --upgrade pip

pip install -r ./infra/service/requirements.txt
```

 - настройка окружения
   > Необходимо скопировать файл .env.dist в каталоге bookmarks_bucket и сохранить его под именем .env
   > Затем заполнить шаблон строки подключения к БД.

 - предварительные команды (предполагается, что пользователь находится в корневом каталоге проекта, у него открыта консоль)

 ```shell
cd bookmarks_bucket

python ./manage.py migrate

python ./manage.py createsuperuser (далее пройти диалог с мастером добавления супер-пользователей)

python ./manage.py add_default_link_types

```
Последний вызов заполнит справочную таблицу в БД (тип контента).
Идемпотентность не нарушена: повторный вызов команды не добавить в таблицу дубликаты.

 - запуск проекта (предполагается, что у пользователя открыта консоль в каталоге bookmarks_bucket)

 ```shell
python ./manage.py runserver 
```

## Запуск в контейнере.

 - Перейдите в корневой каталог проекта (в котором лежит `docker-compose.yml`).
 - Скопируйте `.docker.env.dist` и сохраните его в этом же каталоге под именем `.docker.env`.
 - Заполните `.docker.env`: укажите имя и пароль пользователя БД, а также имя учётной записи администратора Django.
 - Скопируйте `.env.dist` из каталога с кодом в каталог `infra/service` под именем `.service.env`.
 - Заполните строку подключения согласно имени контейнера с БД и настройкам из `.docker.env`.
 - Скопируйте каталог с исходным кодом `bookmarks_bucket` в `infra/service`.
 - Перейдите в корневой каталог (в котором лежит `docker-compose.yml`).
 - Запустите в консоли сборку контейнеров

 ```shell
docker-compose build
```

 - Запустите контейнеры
 ```shell
docker-compose up -d
```

 - Если это первый запуск, то выполните скрипт развёртывания в контейнере с кодом
 ```shell
docker-compose exec bmb bash
cd /app
./deploy.sh
```

 - Введите пароль суперпользователя, подтвердите пароль суперпользователя.
 - Выйдите из контейнера (Ctrl+D)
 - Сервис доступен с хостовой машины по адресу localhost:8000
